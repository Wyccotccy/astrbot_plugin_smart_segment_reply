# 智能分段回复插件

## 插件介绍
AstrBot插件，通过调用硅基流动平台的大模型对Bot回复进行智能分段，每段随机延迟1-3秒发送，模拟真人打字节奏，提升对话自然感。

### 核心功能
- 支持6个预设免费模型，可直接复制填写使用
- 支持自定义模型名称（需硅基流动平台支持）
- 优化提示词+文本去重，彻底解决重复输出问题
- 详细日志输出，便于排查问题
- 自动过滤空段落和重复内容
- 异常时自动回退原始回复，不影响使用

## 安装步骤
1. 下载插件文件夹 `glm4_segment_reply`（包含5个核心文件）
2. 将文件夹复制到AstrBot的插件目录（通常为 `data/plugins/`）
3. 启动AstrBot，在WebUI「插件管理」中找到「GLM-4分段延迟回复（多模型+自定义版）」
4. 点击「配置」完成必要设置，启用插件即可生效

## 配置说明
### 1. 硅基流动API Key
- 前往[硅基流动官网](https://siliconflow.cn)注册账号
- 登录后在「API密钥」页面获取免费API Key（无需充值，预设模型可直接使用）
- 粘贴Key到配置项中，保存即可

### 2. 模型选择（支持预设+自定义）
#### 预设模型（免费可用）
直接复制以下模型名称到配置项中（推荐优先使用 `THUDM/GLM-4-9B-0414`，稳定性最佳）：
1. deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
2. THUDM/GLM-4-9B-0414（默认）
3. THUDM/GLM-Z1-9B-0414
4. Qwen/Qwen3-8B
5. deepseek-ai/DeepSeek-R1-0528-Qwen3-8B
6. THUDM/GLM-4.1V-9B-Thinking

#### 自定义模型
- 手动输入硅基流动平台支持的其他模型名称（需确保模型已在平台上线）
- 注意事项：
  1. 自定义模型可能超出免费额度，需确保API Key有足够余额，避免产生扣费
  2. 模型名称需与硅基流动平台一致（参考：https://siliconflow.cn/models）
  3. 若自定义模型调用失败，插件会自动回退原始回复并记录错误日志

## 使用说明
- 插件启用后自动生效，所有Bot回复会经过模型分段处理
- 分段数量：3-5段，每段延迟1-3秒（随机）
- 日志输出：
  - 分段前：`——模型成功生成回复（原回复：<原回复>），正在尝试分段回复中——`
  - 分段成功：`——分段回复成功，共分<分段数量>段——`
  - 分段失败：`分段失败，发送原消息，失败原因：<报错>`
- 回退机制：若模型调用失败、无有效分段（或仅1段），会自动回退为原始回复

## 注意事项
1. 确保AstrBot能正常访问外网（需调用硅基流动API）
2. 自定义模型前，请确认该模型在硅基流动平台的可用性和计费规则
3. 若出现分段异常（如过短、语义断裂），可切换其他预设模型尝试
4. 插件仅处理文本回复，不影响图片、语音等富媒体消息
5. 日志可在AstrBot日志面板查看，便于排查模型调用和分段问题

## 常见问题
### Q1：提示「未配置API Key」？
A：请检查配置项中是否填写了正确的硅基流动API Key，且无空格、换行等多余字符。

### Q2：仍然出现重复输出？
A：可尝试切换模型（如 `Qwen/Qwen3-8B`），或降低提示词温度（需修改main.py中`temperature`参数，建议0.1-0.3）。

### Q3：模型调用失败（日志显示报错）？
A：1. 检查网络连接是否正常；2. 确认API Key有效性；3. 核实模型名称是否正确（自定义模型需确保平台支持）；4. 若为收费模型，检查API Key余额。

### Q4：如何查看分段日志？
A：在AstrBot WebUI的「系统设置」-「日志管理」中，可查看包含分段相关的详细日志。
，稳定性最佳）：
3. THUDM/GLM-Z1-9B-0414
4. Qwen/Qwen3-8B
5. deepseek-ai/DeepSeek-R1-0528-Qwen3-8B
6. THUDM/GLM-4.1V-9B-Thinking

THUDM/GLM-4-9B-0414（默认）
自定义模型
手动输入硅基流动平台支持的其他模型名称
