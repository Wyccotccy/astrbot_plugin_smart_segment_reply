智能分段回复插件（Smart Segment Reply）

插件介绍
AstrBot插件，通过调用大模型对Bot回复进行智能分段，支持自定义分段延迟时间，模拟真人打字节奏，提升对话自然感。

核心功能
- 支持6个预设免费模型（硅基流动平台），可直接复制填写使用
- 支持自定义模型名称（需硅基流动平台支持）
- 支持自定义API接口地址（可对接其他兼容OpenAI格式的接口）
- 支持配置"无需分段的关键词"，自动跳过系统消息、帮助信息等
- 支持自定义随机延迟时间范围（默认1-3秒）
- 优化提示词+文本清洗，保留原文内容的同时智能分段
- 详细日志输出，便于排查问题
- 自动过滤空段落和序号标记
- 异常时自动回退原始回复，不影响使用
- 完整保存对话历史（包含用户输入和分段后的助手回复）

安装步骤
1. 下载插件文件（包含 `main.py` 和 `_conf_schema.json`）
2. 将文件夹复制到AstrBot的插件目录（通常为 `data/plugins/astrbot_plugin_smart_segment_reply`）
3. 启动AstrBot，在WebUI「插件管理」中找到「智能分段回复插件（astrbot_plugin_smart_segment_reply）」
4. 点击「配置」完成必要设置，启用插件即可生效

配置说明

1. 硅基流动API Key
- 前往[硅基流动官网](https://siliconflow.cn)注册账号
- 登录后在「API密钥」页面获取免费API Key（无需充值，预设模型可直接使用）
- 粘贴Key到配置项中，保存即可

2. 模型选择（支持预设+自定义）

预设模型（免费可用）
直接复制以下模型名称到配置项中（推荐优先使用 `THUDM/GLM-4-9B-0414`，稳定性最佳）：
1. deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
2. THUDM/GLM-4-9B-0414（默认）
3. THUDM/GLM-Z1-9B-0414
4. Qwen/Qwen3-8B
5. deepseek-ai/DeepSeek-R15. deepseek-ai/DeepSeek-R1-0528-Qwen3-8B
6. THUDM/GLM-4.1V-9B-Thinking

自定义模型
- 手动输入硅基流动平台支持的其他模型名称（需确保模型已在平台上线）
- 注意事项：
  1. 自定义模型可能超出免费额度，需确保API Key有足够余额，避免产生扣费
  2. 模型名称需与硅基流动平台一致（参考：https://siliconflow.cn/models）
  3. 若自定义模型调用失败，插件会自动回退原始回复并记录错误日志

3. API接口地址
- 默认使用硅基流动API：`https://api.siliconflow.cn/v1/chat/completions`
- 如需使用其他兼容OpenAI格式的大模型API，可在此修改

4. 无需分段的关键词
- 功能：当回复内容包含配置的任意关键词时，将跳过整段处理（不调用分段模型，直接发送原消息）
- 默认包含：模型列表、帮助、help、指令列表、菜单、功能列表、当前可用的人格、已加载的插件、当前模型
- 使用场景：避免将系统信息、帮助菜单、模型列表等内容强行分段
- 支持自定义添加其他关键词，每行一个，不区分大小写

5. 随机延迟时间范围
- 格式：[最小值, 最大值]，单位秒
- 默认：[1, 3]，表示每段之间延迟1-3秒（第一段不延迟）
- 可根据需要调整，如 [0.5, 1.5] 表示更快的发送节奏，[2, 5] 表示更慢的节奏

使用说明
- 插件启用后自动生效，所有Bot文本回复会经过模型分段处理（不含排除关键词的）
- 分段数量：3-5段（根据原文长度和语义自动判断）
- 延迟逻辑：第一段立即发送，后续每段间隔随机延迟（根据配置的范围）
- 日志输出：
  - 分段前：`——模型成功生成回复（原回复：<原回复>），正在尝试分段回复中——`
  - 检测到排除关键词：`检测到排除关键词 '<关键词>'，跳过分段处理`
  - 分段成功：`——分段回复成功，共分<分段数量>段——`
  - 分段失败：`分段失败，发送原消息，失败原因：<报错>`
- 回退机制：若模型调用失败、无有效分段（或仅1段）、包含排除关键词，会自动回退为原始回复

注意事项
1. 确保AstrBot能正常访问外网（需调用硅基流动API）
2. 自定义模型前，请确认该模型在硅基流动平台的可用性和计费规则
3. 若出现分段异常（如过短、语义断裂），可切换其他预设模型尝试
4. 插件仅处理文本回复（Plain组件），不影响图片、语音等富媒体消息
5. 聊天记录保存：分段回复后，对话历史会完整保存用户输入和分段后的助手回复
6. 日志可在AstrBot日志面板查看，便于排查模型调用和分段问题

常见问题

Q1：提示「未配置API Key」？
A：请检查配置项中是否填写了正确的硅基流动API Key，且无空格、换行等多余字符。

Q2：分段回复后聊天记录里只有 assistant 没有 user？
A：v3.0.2+ 版本已修复，现在会同时保存用户输入和分段后的助手回复。

Q3：帮助信息/模型列表被强制分段很难看？
A：在「无需分段的关键词」配置中添加对应关键词，如"帮助"、"模型列表"等。

Q4：模型调用失败（日志显示报错）？
A：1. 检查网络连接是否正常；2. 确认API Key有效性；3. 核实模型名称是否正确（自定义模型需确保平台支持）；4. 若为收费模型，检查API Key余额；5. 检查API接口地址是否正确。

Q5：如何调整发送速度？
A：修改「随机延迟时间范围」配置，如改为 [0.5, 1] 可加快发送速度。

Q6：如何查看分段日志？
A：在AstrBot WebUI的「系统设置」-「日志管理」中，可查看包含分段相关的详细日志。

版本记录
- v3.0.2：修复聊天记录保存问题（同时保存user和assistant），新增排除关键词和随机延迟范围配置
- v3.0.1：修复重复发送完整消息问题，改为手动保存对话历史
- v3.0.0：初始版本，基础分段回复功能
